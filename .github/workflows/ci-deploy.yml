name: CI + Deploy

on:
    push:
        branches: [main]

jobs:
    ci:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                    node-version: 20
                    cache: "npm"
                    cache-dependency-path: frontend/package-lock.json

            - name: Frontend install
              working-directory: frontend
              run: npm ci
            
            - name: Frontend lint
              working-directory: frontend
              run: npm run lint

            - name: Frontend format check
              working-directory: frontend
              run: npm run format

            - name: Frontend typecheck
              working-directory: frontend
              run: npm run typecheck

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                python-version: "3.13"
            
            - name: Backend install
              run: |
               python -m pip install --upgrade pip
               pip install -r backend/requirements.txt -r backend/requirements-dev.txt

            - name: Backend lint
              run: ruff check backend

            - name: Backend format check
              run: ruff format --check backend

            - name: Backend tests
              working-directory: backend
              run: pytest

    deploy:
        runs-on: ubuntu-latest
        needs: ci

        steps:
            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.2.4
              with:
                host: ${{ secrets.DEPLOY_HOST }}
                username: ${{ secrets.DEPLOY_USER }}
                key: ${{ secrets.DEPLOY_KEY }}
                script: |
                  cd /home/deploy/M62
                  git pull
                  docker compose up -d --build