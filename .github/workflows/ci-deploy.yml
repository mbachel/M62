name: CI + Deploy

on:
    push:
        branches: [main]
        tags: [v*]

jobs:
    ci:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                fetch-depth: 0

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                    node-version: 20
                    cache: "npm"
                    cache-dependency-path: frontend/package-lock.json

            - name: Frontend install
              working-directory: frontend
              run: npm ci
            
            - name: Frontend lint
              working-directory: frontend
              run: npm run lint

            - name: Frontend format check
              working-directory: frontend
              run: npm run format

            - name: Frontend typecheck
              working-directory: frontend
              run: npm run typecheck

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                python-version: "3.13"
            
            - name: Backend install
              run: |
               python -m pip install --upgrade pip
               pip install -r backend/requirements.txt -r backend/requirements-dev.txt

            - name: Backend lint
              run: ruff check backend

            - name: Backend format check
              run: ruff format --check backend

            - name: Backend tests
              working-directory: backend
              run: pytest

    deploy:
        runs-on: ubuntu-latest
        needs: ci

        steps:
            - name: Determine deployment mode
              id: deploy_mode
              run: |
                if [[ "${{ github.ref }}" ==refs/tags/* ]]; then
                  echo "mode=tag" >> $GITHUB_OUTPUT
                  echo "ref=${{ github.ref_name }}" >> $GITHUB_OUTPUT
                else
                  echo "mode=main" >> $GITHUB_OUTPUT
                  echo "ref=main" >> $GITHUB_OUTPUT
                fi

            - name: Deploy via SSH (Tag - Stable)
              if: steps.deploy_mode.outputs.mode == 'tag'
              uses: appleboy/ssh-action@v1.2.4
              with:
                host: ${{ secrets.DEPLOY_HOST }}
                username: ${{ secrets.DEPLOY_USER }}
                key: ${{ secrets.DEPLOY_KEY }}
                script: |
                  cd /home/deploy/M62
                  git fetch origin
                  git checkout ${{ steps.deploy_mode.outputs.ref }}

                  # track deployment
                  mkdir -p .deployment/backups
                  echo "${{ steps.deploy_mode.outputs.ref }}" >> .deployment/current_version

                  docker compose down
                  docker compose up -d --build
                  
                  echo "Deployed ${{ steps.deploy_mode.outputs.ref }} (stable)"

            - name: Deploy via SSH (Main - Iteration)
              if: steps.deploy_mode.outputs.mode == 'main'
              uses: appleboy/ssh-action@v1.2.4
              with:
                host: ${{ secrets.DEPLOY_HOST }}
                username: ${{ secrets.DEPLOY_USER }}
                key: ${{ secrets.DEPLOY_KEY }}
                script: |
                  cd /home/deploy/M62
                  git pull

                  # track deployment
                  mkdir -p .deployment/backups
                  COMMIT_SHA=$(git rev-parse --short HEAD)
                  echo "main-$COMMIT_SHA-$(date +%s)" >> .deployment/current_version

                  docker compose up -d --build
                  
                  echo "Auto-deployed main branch (iteration)"